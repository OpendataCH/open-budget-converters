<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <link type="text/css" rel="stylesheet" href="flare.css"/>
	<title>Stadt Bern Nettoausgaben - Budget 2012</title>
    <style type="text/css">
		text {
			font-size: 11px;
			pointer-events: none;
		}
		
		text.parent {
			fill: #e1353f; /*e1353f*/
			text-shadow:0 0 20px #fff;
			font-weight:bold;
			font-size:15px;
		}
		
		text.parent.directorate {
			fill: #a8272d;
			font-size:20px;
		}
		
		circle {
			fill: #e1353f;
			fill-opacity: .1;
			stroke: #e1353f;
			pointer-events: all;
		}
		
		circle.parent {
			fill: #a8272d;
			fill-opacity: .1;
			stroke: #a8272d;
		}
		
		circle:hover {
			stroke: #ff7f0e;
			stroke-width: .5px;
		}
    </style>
  </head>
  <body>
  	<div id="infobox">
  		<a href="http://make.opendata.ch/doku.php?id=project:bern_budget" target="_blank"><img id="logo" src="logo.png" /></a>
		<h1>Stadt Bern Nettoausgaben<br />Budget 2012</h1>
		<div id="hoverNodeInfo">
			<h2></h2>
			<p></p>
		</div>
		<div id="rootNodeInfo">
			<h2></h2>
			<p></p>
		</div>
		<div id="sizeCalculator">
			<h2></h2>
			<p></p>
		</div>
  	</div>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript" src="js/d3.js"></script>
    <script type="text/javascript" src="js/d3.layout.js"></script>
    <script type="text/javascript">

$(function() {
	var $window = $(window);
	
	if(!(!!document.createElementNS && !!document.createElementNS('http://www.w3.org/2000/svg', "svg").createSVGRect)) {
		$('body').append('<div id="warning"><h2>Browser inkompatibel</h2><p>Leider unterst√ºzt ihr Browser kein SVG.<br /><br />Wir empfehlen: <span class="recommendation"></span></p><div class="close">X</div></div>');
		if(navigator.userAgent.search(/Mac OS X/) !== -1) {
			$('#warning .recommendation').html('<a href="http://www.apple.com/safari/" target="_blank">Apple Safari</a>');
		}
		else {
			$('#warning .recommendation').html('<a href="http://www.mozilla.org/firefox/" target="_blank">Firefox</a> oder <a href="https://www.google.com/chrome" target="_blank">Google Chrome</a>');
		}
		$('#warning .close').click(function(){
			$('#warning').fadeOut();
		});
	}
	
	var w = 0,
	    h = 0,
	    r = 720,
	    x = d3.scale.linear().range([0, r]),
	    y = d3.scale.linear().range([0, r]),
	    node,
	    root;
	
	var pack = d3.layout.pack()
	    .size([r, r])
	    .value(function(d) { return d.size; });
	
	var vis = d3.select("body").insert("svg:svg")
	  .append("svg:g");
	
	var zoomLevels = {
		'directorate': 0,
		'agency': 1,
		'product_group': 2
	}
	
	var curZoomLevel = 0;
	
	$window.resize(function() {
		w = $window.width(),
	    h = $window.height(),
		vis.attr("width", w)
			.attr("height", h)
			.attr("transform", "translate(" + (w - r) / 2 + "," + (h - r) / 2 + ")");
	}).resize();
	
	var $rootNodeInfo = $('#rootNodeInfo'), $hoverNodeInfo = $('#hoverNodeInfo'), $sizeCalculator = $('#sizeCalculator');
	
	var displayedNodes = {};
	
	var formatCHF = d3.format(',');
	var setDisplayNodeInfo = function(node, type) {
		var $nodeInfo, animated = true;
		if(type == 'root') {
			$nodeInfo = $rootNodeInfo;
		}
		else if(type == 'hover') {
			$nodeInfo = $hoverNodeInfo;
			//animated = false;
		}
		
		if(displayedNodes['root'] == node) {
			$nodeInfo.animate({'opacity':0,'height':0},{'queue':false});
			return;
		}
		displayedNodes[type] = node;
		
		var setText = function($target) {
			$target.find('h2').text(node.name + (node.acronym ? ' ('+node.acronym+')': ''));
			$target.find('p').text('CHF '+formatCHF(node.size)+'.-');
		};
		
		$nodeInfo.stop().animate({'opacity':0}, {'queue':false,'complete':function() {
			setText($sizeCalculator);
			setText($nodeInfo);
			$nodeInfo.slideDown();
			$nodeInfo.animate({'opacity': 1,'height':$sizeCalculator.height()},{'queue':false});
		}});
	}
	
	d3.json("data/flare.json", function(data) {
		node = root = data;
	  
		setDisplayNodeInfo(node, 'root');
		
		pack.sort(function(a, b) {
			//console.log(a, b);
			return b.size - a.size;
		});
		
		var nodes = pack.nodes(root);
	
		vis.selectAll("circle")
		    .data(nodes)
		  .enter().append("svg:circle")
		    .attr("class", function(d) { return (d.children ? "parent" : "child")+(d.type ? ' '+d.type : ''); })
		    .attr("cx", function(d) { return d.x; })
		    .attr("cy", function(d) { return d.y; })
		    .attr("r", function(d) { return d.r; })
		    .on("click", function(d) { return zoom(node == d ? root : d); })
		    .on("mouseover", function(d) { setDisplayNodeInfo(d, 'hover'); });
	
		vis.selectAll("text")
		    .data(nodes)
		  .enter().append("svg:text")
		    .attr("class", function(d) { return (d.children ? "parent" : "child")+(d.type ? ' '+d.type : ''); })
		    .attr("x", function(d) { return d.x; })
		    .attr("y", function(d) { return d.y; })
		    .attr("dy", function(d) { return ((d.children || d.parent.children.length > 2) ? ".35em" : "2.35em"); })
		    .attr("text-anchor", "middle")
		    .style("opacity", function(d) { return zoomLevels[d.type] <= curZoomLevel ? 1 : 0; })
		    .text(function(d) { return d.acronym ? d.acronym : d.name; });
	
		d3.select(window).on("click", function() { zoom(root); });
	});
	
	function zoom(d, i) {
		if(zoomLevels[d.type] !== undefined) {
			curZoomLevel = zoomLevels[d.type] + 1;
		}
		else {
			curZoomLevel = 0;
		}
		
		var k = r / d.r / 2;
		x.domain([d.x - d.r, d.x + d.r]);
		y.domain([d.y - d.r, d.y + d.r]);
	
		var t = vis.transition()
		    .duration(d3.event.altKey ? 7500 : 750);
	
		t.selectAll("circle")
		    .attr("cx", function(d) { return x(d.x); })
		    .attr("cy", function(d) { return y(d.y); })
		    .attr("r", function(d) { return k * d.r; });
	
		t.selectAll("text")
		    .attr("x", function(d) { return x(d.x); })
		    .attr("y", function(d) { return y(d.y); })
		    .style("opacity", function(d) { return (zoomLevels[d.type] <= curZoomLevel) && (k * d.r > 20) ? 1 : 0; });
	
		node = d;
		d3.event.stopPropagation();
	}
});

    </script>
  </body>
</html>